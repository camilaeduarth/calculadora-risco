<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INCA | Calculadora de Risco</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
    font-family:Segoe UI, sans-serif;
    background:linear-gradient(135deg,#0b5fa5,#0aa6a6);
    padding:20px;
}
.container{
    max-width:1000px;
    margin:auto;
    background:white;
    border-radius:16px;
    padding:30px;
}
h1{color:#0b5fa5;}
.section{margin-top:25px;}
input,select{
    padding:8px;
    border:2px solid #ddd;
    border-radius:8px;
    width:100%;
}
button{
    padding:12px;
    border:none;
    border-radius:8px;
    background:linear-gradient(135deg,#0b5fa5,#0aa6a6);
    color:white;
    font-weight:bold;
    margin-top:20px;
    cursor:pointer;
}
.result{
    margin-top:30px;
    padding:20px;
    background:#f5f5f5;
    border-radius:12px;
}
.bar{
    height:30px;
    background:#ddd;
    border-radius:6px;
    overflow:hidden;
}
.fill{
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:bold;
}
.low{background:#28a745;}
.medium{background:#ffc107;}
.high{background:#dc3545;}
</style>
</head>
<body>

<div class="container">

<h1>Calculadora de Risco</h1>

<div class="section">
<h3>Dados Clínicos</h3>
<input id="age" type="number" placeholder="Idade">
<input id="fev1" type="number" placeholder="FEV1 (%)">
<input id="imc" type="number" placeholder="IMC">
<select id="location">
<option value="">Localização JEG</option>
<option value="1">Sim</option>
<option value="0">Não</option>
</select>
<select id="smoking">
<option value="">Tabagismo</option>
<option value="1">Sim</option>
<option value="0">Não</option>
</select>
</div>

<div class="section">
<h3>Dados Dosimétricos</h3>
<input id="v5" type="number" placeholder="V5 (%)">
<input id="v10" type="number" placeholder="V10 (%)">
<input id="v20" type="number" placeholder="V20 (%)">
<input id="v30" type="number" placeholder="V30 (%)">
<input id="dpm" type="number" placeholder="DPM (cGy)">
</div>

<button onclick="calcular()">Calcular Risco</button>

<div id="resultado" class="result" style="display:none;">
<h3 id="titulo"></h3>
<div class="bar">
<div id="barra" class="fill"></div>
</div>
<p><strong>V5/V20:</strong> <span id="ratio"></span></p>
<canvas id="grafico" height="120"></canvas>
</div>

</div>

<script>

// ===== MODELO LOGÍSTICO CALIBRADO =====
const MODEL = {
intercept:-2.85,
beta:{
location:0.92,
ratio:0.08,
age:0.05,
fev1:-0.015,
v20:0.04,
v30:0.02,
smoking:0.35,
imc:0.01
}
};

let chart;

function n(v){
    const x=parseFloat(v);
    return isNaN(x)?0:x;
}

function logistic(z){
    return 1/(1+Math.exp(-z));
}

function classificar(p){
    if(p<0.30) return "low";
    if(p<0.70) return "medium";
    return "high";
}

function calcular(){

    if(!age.value||!fev1.value||!imc.value||!location.value||
       !smoking.value||!v5.value||!v10.value||!v20.value||
       !v30.value||!dpm.value){
        alert("Preencha todos os campos.");
        return;
    }

    const data={
        age:n(age.value),
        fev1:n(fev1.value),
        imc:n(imc.value),
        location:n(location.value),
        smoking:n(smoking.value),
        v5:n(v5.value),
        v10:n(v10.value),
        v20:n(v20.value),
        v30:n(v30.value),
        dpm:n(dpm.value)
    };

    const ratio=data.v20>0?data.v5/data.v20:0;

    const z=MODEL.intercept
        +MODEL.beta.location*data.location
        +MODEL.beta.ratio*ratio
        +MODEL.beta.age*data.age
        +MODEL.beta.fev1*data.fev1
        +MODEL.beta.v20*data.v20
        +MODEL.beta.v30*data.v30
        +MODEL.beta.smoking*data.smoking
        +MODEL.beta.imc*data.imc;

    const p=logistic(z);
    const percent=Math.round(p*100);

    const risco=classificar(p);

    resultado.style.display="block";
    titulo.innerText="Risco: "+percent+"%";

    barra.style.width=percent+"%";
    barra.className="fill "+risco;
    barra.innerText=percent+"%";

    ratio.innerText=ratio.toFixed(2);

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("grafico"),{
        type:"line",
        data:{
            labels:["V5","V10","V20","V30","DPM(Gy)","V5/V20"],
            datasets:[{
                data:[data.v5,data.v10,data.v20,data.v30,data.dpm/100,ratio],
                borderColor:"#0b5fa5",
                tension:0.3
            }]
        },
        options:{responsive:true}
    });
}

</script>

</body>
</html>
